<!DOCTYPE html>

<html>

<head>
    <title>Recipe Blog</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans">
    <div class="flex justify-between items-center p-2.5 bg-gray-100">
        <h1 class="text-center text-gray-800 text-2xl">Recipe Blog</h1>
        <a href="/goals" class="bg-green-500 text-white px-4 py-2 rounded no-underline hover:bg-green-600">Goals</a>
    </div>
    
<!-- Search Bar -->
<div class="p-4">
    <form method="GET" action="/search" class="flex gap-2">
      <input 
        type="text" 
        name="q" 
        placeholder="Search recipes..." 
        value="{{ query or '' }}" 
        class="flex-1 px-3 py-2 border border-gray-300 rounded"
    />
    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Search</button>
  </form>
</div>

<div class="bg-white p-8 rounded-xl shadow-md w-96 mx-auto my-5">
<h1 class="text-center text-gray-800 mb-6 text-xl">Post</h1>
    
    <form method="POST">
        <label class="block mt-4 font-bold text-gray-600">Title</label><input type="text" name="title" placeholder="Ex: Grandma's Chocolate Chip Cookies"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base"><br>
        <label>Cuisine</label><input type="text" name="cuisine" placeholder="Ex: Italian, Greek"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base"><br>
        <label>Ingredients</label><input type="text" name="ingredients" placeholder="Ex: Chicken breast, brown rice, paprika, vegetable oil"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base"><br>
        <label class="block mt-4 font-bold text-gray-600">Macros</label>
        <input type="number" name="cals" placeholder="Calories"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base">
        <input type="number" name="protein" placeholder="Protein (g)"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base">
        <input type="number" name="carbs" placeholder="Carbohydrates (g)"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base">
        <input type="number" name="fats" placeholder="Fats (g)"
        class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base">
        <label class="block mt-4 font-bold text-gray-600">Instructions</label><textarea name="content" class="w-full p-2 mt-1.5 border border-gray-300 rounded text-base h-24 resize-y"> </textarea><br>
        <button type="submit" class="block w-full mt-6 p-3 bg-green-500 text-white text-base border-0 rounded cursor-pointer hover:bg-green-600">Submit form</button>
    </form>
    </div>

<!-- Filter Form -->
<div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto my-5">
  <h2 class="text-center text-gray-800 mt-12 text-3xl mb-4">Filter Recipes</h2>
  <form method="GET" action="/">
    <div class="flex gap-2 items-center mb-3">
      <label class="font-semibold w-32">Calories:</label>
      <input type="number" name="min_cals" placeholder="Min"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
      <input type="number" name="max_cals" placeholder="Max"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
    </div>
    <div class="flex gap-2 items-center mb-3">
      <label class="font-semibold w-32">Protein (g):</label>
      <input type="number" name="min_protein" placeholder="Min"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
      <input type="number" name="max_protein" placeholder="Max"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
    </div>
    <div class="flex gap-2 items-center mb-3">
      <label class="font-semibold w-32">Carbs (g):</label>
      <input type="number" name="min_carbs" placeholder="Min"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
      <input type="number" name="max_carbs" placeholder="Max"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
    </div>
    <div class="flex gap-2 items-center mb-3">
      <label class="font-semibold w-32">Fats (g):</label>
      <input type="number" name="min_fats" placeholder="Min"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
      <input type="number" name="max_fats" placeholder="Max"
      class="flex-1 px-3 py-2 border border-gray-300 rounded">
    </div>
    <button type="submit" class="w-full mt-4 p-3 bg-green-500 text-white rounded hover:bg-green-600">Apply Filters</button>
  </form>
</div>



<h2 class="text-center text-gray-800 mt-12 text-3xl">Recipes</h2>
<div class="grid grid-cols-[repeat(auto-fit,minmax(300px,1fr))] gap-6 p-8">
  {% for post in posts %}
    <div class="bg-white rounded-xl p-6 shadow-md hover:-translate-y-1 hover:shadow-lg transition-all cursor-pointer">
      <h3 class="m-0 mb-2 text-2xl text-blue-700">{{ post['title'] }}</h3>
      {% if post['cuisine'] %}
        <p class="my-2 leading-6 text-gray-600"><strong>Cuisine:</strong> {{ post['cuisine'] }}</p>
      {% endif %}
      {% if post['ingredients'] %}
        <p class="my-2 leading-6 text-gray-600"><strong>Ingredients:</strong> {{ post['ingredients'] }}</p>
      {% endif %}
      <div class="flex flex-wrap gap-2 mt-2">
        {% if post['cals'] %}<span class="bg-gray-100 px-2 py-1 rounded text-sm">{{ post['cals'] }} cal</span>{% endif %}
        {% if post['protein'] %}<span class="bg-gray-100 px-2 py-1 rounded text-sm">{{ post['protein'] }}g protein</span>{% endif %}
        {% if post['carbs'] %}<span class="bg-gray-100 px-2 py-1 rounded text-sm">{{ post['carbs'] }}g carbs</span>{% endif %}
        {% if post['fats'] %}<span class="bg-gray-100 px-2 py-1 rounded text-sm">{{ post['fats'] }}g fats</span>{% endif %}
      </div>
      {% if post['content'] %}
        <p class="my-2 leading-6 text-gray-600">{{ post['content'] }}</p>
      {% endif %}
    </div>
  {% endfor %}
</div>

<!-- Modal  -->
<div id="recipeModal" class="hidden fixed z-[1000] left-0 top-0 w-full h-full bg-black/40">
  <div class="bg-white my-[10%] mx-auto p-8 rounded-xl w-4/5 max-w-2xl shadow-lg relative">
    <span class="close-btn absolute top-3 right-5 text-2xl font-bold text-gray-600 cursor-pointer hover:text-black">&times;</span>
    <h3 id="modal-title" class="text-2xl mb-4"></h3>
    <p id="modal-cuisine" class="mb-2"></p>
    <p id="modal-ingredients" class="mb-2"></p>
    <div id="modal-macros" class="mb-2"></div>
    <p id="modal-content" class="mb-4"></p>
    <button id="addToGoalsBtn" class="mt-4 bg-blue-700 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-800">Add to Goals</button>
  </div>
</div>

<script>
  const modal = document.getElementById("recipeModal");
  const closeBtn = document.querySelector(".close-btn");

  closeBtn.onclick = () => {
    modal.classList.add("hidden");
  };

  window.onclick = (event) => {
    if (event.target === modal) {
      modal.classList.add("hidden");
    }
  };

const addToGoalsBtn = document.getElementById("addToGoalsBtn");

let currentRecipe = {};

document.querySelectorAll(".bg-white.rounded-xl.p-6.shadow-md").forEach(card => {
  card.addEventListener("click", () => {
    const title = card.querySelector("h3")?.innerText || "";
    const cuisine = card.querySelector("p:nth-of-type(1)")?.innerText || "";
    const ingredients = card.querySelector("p:nth-of-type(2)")?.innerText || "";
    const macrosDiv = card.querySelector("div");
    const content = card.querySelector("p:last-of-type")?.innerText || "";

    // Model the macro retrieval off of the code above
    const cals = parseFloat(macrosDiv?.querySelector("span:nth-child(1)")?.innerText) || 0;
    const protein = parseFloat(macrosDiv?.querySelector("span:nth-child(2)")?.innerText) || 0;
    const carbs = parseFloat(macrosDiv?.querySelector("span:nth-child(3)")?.innerText) || 0;
    const fats = parseFloat(macrosDiv?.querySelector("span:nth-child(4)")?.innerText) || 0;

    currentRecipe = { title, cuisine, ingredients, cals, protein, carbs, fats, content };

    document.getElementById("modal-title").innerText = title;
    document.getElementById("modal-cuisine").innerText = cuisine;
    document.getElementById("modal-ingredients").innerText = ingredients;
    document.getElementById("modal-macros").innerText = `${cals} cal | ${protein}g protein | ${carbs}g carbs | ${fats}g fats`;
    document.getElementById("modal-content").innerText = content;

    modal.classList.remove("hidden");
  });
});

//JSONify the 'currentrecpie' to send to the goals thru POST request
addToGoalsBtn.addEventListener("click", () => {
  fetch("/add_to_goals", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(currentRecipe)
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message || "Added to goals!");
    modal.classList.add("hidden");
  })
  .catch(err => {
    console.error(err);
    alert("Error adding to goals.");
  });
});
</script>


</body>
</html>